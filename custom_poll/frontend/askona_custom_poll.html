<%

    var _handler = ArrayOptFirstElem(XQuery('for $elem in custom_web_templates where $elem/code="askona_poll_handler" return $elem'));
    var poll_id = Request.Query.GetOptProperty('poll_id', undefined);

    OPTIONS = 
    {
        handler_id: _handler.id.Value,
        poll_id: poll_id
    };

%>
<!-- <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"> -->
<html>
<head>
	<title>Опросы</title>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
   	<meta name="viewport" content="width=device-width, initial-scale=1">
	<!-- <link rel="stylesheet" href="css/normalize.css">
	<link rel="stylesheet" href="css/main.css">
	<link rel="stylesheet" href="css/queries.css"> -->
</head>
<!--
	Изменили стиль убрав правую колонку
-->
<style>

.left-col {
    float: left;
    width: 100%;
    margin-right: 2.12765957%;
}

.a-btn.disabled, a.a-btn.disabled, button.a-btn.disabled, input[type="submit"].a-btn.disabled {
    cursor: default;
    background-color: transparent;
    color: #00b9bf;
}

.a-btn:hover {
    background-color: transparent;
    color: #00787c !important;
}

.a-btn:hover:not(.disabled), a.a-btn:hover:not(.disabled), button.a-btn:hover:not(.disabled), input[type="submit"].a-btn:hover:not(.disabled) {
    border-color: #00787c;
    background-color: transparent;
    color: #fff;
}

.block-title {
	border-color: #00787c;
    background-color: #00b9bf;
    padding: 10px;
    border-radius: 5px;
    color: white;
}

.modal__overlay {
	position: fixed;
	left: 0;
	top: 0;
	width: 100%;
	height: 100%;
	z-index: 99999;
	background-color: rgba(0, 0, 0, .6);
}

.modal__window {
	position: absolute;
	margin: 0 auto;
	background-color: #ffffff;
	border-radius: 25px;
	left: 50%;
	top: 50%;
	transform: translateX(-50%) translateY(-50%);
	padding: 20px 100px;
}

.modal__buttons {
	width: 100%;
	display: flex;
	justify-content: center;
}

.modal__title {
	text-align: center;
}

.radio-item {
	cursor: pointer;
}
.notif-progress {
	background-color: #00b9bf;
}
.notif-content {
	background-color: #00b9bf;
}

</style>

<body>
	<div class="main-wrapper">
		<!-- 
		**********************HEADER************************
		 -->
		<div class="a-container">
			
		</div>
		<!-- 
		**********************CONTANT************************
		 -->
		<div class="a-container">
			<div class="clearfix a-card-wrap">
				<div class="main-child left-col js-left">
					<h2 id="poll_name"><span>Опрос</span></h2>
					<p id="poll_description"></p>
					<div class="comment-list">
						<!-- <div class="comment-item">
							<p class="comment-q">Вопрос 1</p>
							<ul class="radio-group">
								<li><a href="javascript:;" class="radio-item"><i></i>Ответ 1</a></li>
								<li><a href="javascript:;" class="radio-item"><i></i>Ответ 2</a></li>
								<li><a href="javascript:;" class="radio-item"><i></i>Ответ 3</a></li>
								<li><a href="javascript:;" class="radio-item"><i></i>Ответ 4</a></li>
								<li><a href="javascript:;" class="radio-item"><i></i>Ответ 5</a></li>
							</ul>
						</div>
						<div class="comment-item">
							<p class="comment-q">Вопрос 2</p>
							<ul class="checkbox-group">
								<li><a href="javascript:;" class="checkbox-item active"><i></i>Ответ 1</a></li>
								<li><a href="javascript:;" class="checkbox-item"><i></i>Ответ 2</a></li>
								<li><a href="javascript:;" class="checkbox-item"><i></i>Ответ 3</a></li>
								<li><a href="javascript:;" class="checkbox-item"><i></i>Ответ 4</a></li>
								<li><a href="javascript:;" class="checkbox-item"><i></i>Ответ 5</a></li>
								<li><a href="javascript:;" class="checkbox-item"><i></i>Ответ 6</a></li>
							</ul>
						</div>
						<div class="comment-item">
							<p class="comment-q">Вопрос 3</p>
							<textarea  class="a-input"></textarea>
						</div> -->
					</div>
                    <!--disabled modal-close-btn-->
					<div class="btn-wrap">
						<button class="a-btn" id="submit-poll">Отправить</button>
					</div>
				</div>
				<!-- <div class="right-col js-right">
					<div class="a-col-4">
						<h3>Другие опросы</h3>
						<div class="a-col">
							<a href="#" class="main-child">
								Какое электронное обучение проводится в вашей компании?
							</a>
						</div>
						<div class="a-col">
							<a href="#" class="main-child">
								Пользователи СДО. Кто они?
							</a>
						</div>
						<div class="a-col">
							<a href="#" class="main-child">
								Оцените факторы, влияющие на эффективность обучения
							</a>
						</div>
					</div>
				</div> -->
			</div>
			
		</div>

		<div class="page-bottom">
			<div class="a-container">
				
			</div>
		</div>

		<div id="modal1" class="modal__overlay">
	        <div class="modal__window">
				<h2 class="modal__title">Some title</h2>
				<div class="modal__content"></div>
				<div class="btn-wrap modal__buttons">
					<button class="a-btn" id="close_modal">Закрыть</button>
				</div>
			</div>
	    </div>

	</div>

</body>
</html>

<script>
    (function(options){

		function CreateQuestionBlock(question, is_block = false) {
			const question_div = $("<div>", {
				class: "comment-item",
				"data-question-id": question.id,
				"data-question-type": question.type
			})

			if (is_block) return question_div

			const question_text = $("<p>", {
				class: "comment-q",
				text: question.title
			})

			question_div.append(question_text)

			return question_div
		}

		function CreateChoiceQuestion(question) {
			const question_div = CreateQuestionBlock(question)

			const textarea = $("<textarea>", {
				class: "a-input",
				placeholder: "Объясните свой выбор"
			}).hide()

			const answers_list = $("<ul>", {
				class: "radio-group"
			})

			for (const answer of question.answers) {
				const answer_item = $("<li>")

				const answer_item_text = $("<a>", {
						class: "radio-item",
						"data-answer-id": answer.id,
						"data-comment-required": answer.comment_required,
						"data-answer-weight": answer.weight || 0
				})
				answer_item_text.html('<i></i>' + answer.value); 
				// .append( $("<i>") ).text(answer.value)

				answer_item.append(answer_item_text)

				answer_item_text.click(function () {
					question_div.find(".radio-item.active").removeClass("active")
					$(this).addClass("active")

					if ($(this).data("comment-required")) {
						textarea.show()	
					} else {
						textarea.hide().val("")
					}
				})

				answers_list.append(answer_item)
			}

			question_div.append(answers_list)
			question_div.append(textarea)

			return question_div
		}

		function CreateTextQuestion(question) {
			const question_div = CreateQuestionBlock(question)

			const textarea = $("<textarea>", {
				class: "a-input",
				placeholder: "Место для ответа"
			})

			question_div.append(textarea)

			return question_div
		}

		function CreateBlockTitle(question) {
			const question_div = CreateQuestionBlock(question, true);

			const question_block_title = $("<p>", {
				class: "block-title",
				text: question.title
			})

			question_div.append(question_block_title)

			return question_div
		}

		function RenderQuestions(questions) {

			for (const question of questions) {
				switch (question.type) {
					case "choice":
						var question_elem = CreateChoiceQuestion(question)
						break

					case "text":
						var question_elem = CreateTextQuestion(question)
						break

					case "block":
						var question_elem = CreateBlockTitle(question)
						break
				}
				$(".comment-list").append(question_elem)
			}

		}

        function fillPage() {
            $.ajax({
                type: "POST",
                url: "/custom_web_template.html?object_id=" + options.handler_id,
                secureuri: false,
                dataType: "json",
                data:
                    {
                        poll_id: options.poll_id
                    },
                    success: function (response, textStatus, jqXHR)
                    {   
						if (!response.success) return
                        
						RenderQuestions(response.data.questions)

						options.poll_code = response.data.code
						console.log(options)

						$("#poll_description").html(response.data.description)
						$("#poll_name").append(response.data.name)
						// setEvents();
                    }
                });
            }
        
		function BuildResult() {
			const result = [];
			const values = [];
			let value = null

			$(".comment-item").each(function() {
				const question = {
					id: $(this).data("question-id"),
					value: null,
					comment: null,
					comment_required: false
				}

				switch ($(this).data("question-type")) {
					case "block":
						if (value != null) values.push(value)
						value = {
							points: 0,
							count: 0,
							title: $(this).find(".block-title").text()
						}
						return

					case "choice":
						const selected = $(this).find(".active")
						if (!selected.length) break
						value.count++;
						value.points += selected.data("answer-weight")

						question.value = selected.data("answer-id") 

						if (!selected.data("comment-required")) break
						question.comment_required = true
						question.comment = $(this).find(".a-input").val()
						break
					
					case "text":
						question.value = $(this).find(".a-input").val()
						break
				}
				
				result.push(question)
			})
			values.push(value)
			return {
				values,
				result
			}
		}

		function BuildValuesDescriptions(values)
		{
			function CalcGrade(value) {
				const avg = value.points / value.count
				if (avg >= 2.5) return "A"
				if (avg >= 2) return "B"
				if (avg >= 1) return "C"
				return "D"
			}

			const descriptions = {
				'ЦЕННОСТЬ "КОМАНДА"': {
					"A": "Вы формируете атмосферу взаимоуважения и командного духа, делаете вклад в общий успех, повышаете эффективность работы команды и способствуете её развитию. Вы вносите значимый вклад в достижение общих целей команды, стремитесь к повышению эффективности работы команды и привносите новые идеи и методы в работу. Вы формируете атмосферу доверия и взаимопонимания в команде, способствуете успешному взаимодействию между коллегами, поощряете открытое общение и обмен опытом. Вы постоянно развиваете свои профессиональные навыки и ищете новые знания и опыт, стремитесь к совершенствованию и росту.",
					"B": "Вы не боитесь брать на себя ответственность за сложные задачи, помогаете команде решать проблемы и преодолевать препятствия, вдохновляете других на достижение общих целей. Не боитесь принимать риски и пробовать новые подходы, способны адаптироваться к изменениям и решать нестандартные задачи, вы вдохновляете других на достижение лучших результатов. Не боитесь высказывать свое мнение и отстаивать свою позицию, способны конструктивно решать конфликты, готовы прислушиваться к мнению других.",
					"C": "Вы выполняете свою работу качественно и в срок и взаимодействуете с командой в рамках своих обязанностей. Вы выполняете свою работу в соответствии с требованиями, способны решать стандартные задачи, готовы следовать инструкциям. Поддерживаете хорошие отношения с коллегами и готовы помогать им в необходимых ситуациях, вы уважаете мнение других. Вы выполняете свою работу в соответствии с требованиями.",
					"D": "Вы редко выполняете свою работу качественно и в срок, не стремитесь к командной работе и редко помогаете коллегам. Редко вносите значимый вклад в достижение общих целей и не стремитесь к повышению эффективности, редко предлагаете новые идеи. Редко высказываете свое мнение и не готовы прислушиваться к мнению других. Редко развиваете свои профессиональные навыки, не стремитесь к повышению квалификации и не готовы учиться на своих ошибках."
				},
				'ЦЕННОСТЬ "КЛИЕНТОЦЕНТРИЧНОСТЬ"': {
					"A": "<b>Внутренние клиенты</b>:<br>Вы формируете атмосферу взаимоуважения и открытости в команде, делаете все возможное, чтобы коллеги чувствовали себя ценными и мотивированными, вкладываетесь в их развитие и поддержку. Вы вносите значимый вклад в достижение общих целей команды, стремитесь к повышению эффективности работы команды, привносите новые идеи и методы в работу.<br><br><b>Внешние клиенты:</b><br>Вы формируете позитивный образ компании в глазах клиентов, делаете все возможное, чтобы клиенты чувствовали себя удовлетворенными и лояльными, вкладываетесь в повышение качества обслуживания. Вносите значимый вклад в успех компании за счет удовлетворенности клиентов, стремитесь к повышению лояльности клиентов и привносите новые идеи и методы в работу с клиентами.",
					"B": "<b>Внутренние клиенты</b>:<br>Вы не боитесь брать на себя ответственность за создание благоприятной атмосферы в команде, готовы решать конфликты и улаживать разногласия, вдохновляете команду на достижение общих целей. Не боитесь принимать риски и пробовать новые подходы, способны адаптироваться к изменениям и решать нестандартные задачи. Вдохновляете других на достижение лучших результатов.<br><br><b>Внешние клиенты:</b><br>Вы не боитесь брать на себя ответственность за удовлетворенность клиентов, готовы решать проблемы клиентов и идти на компромисс. Не боитесь принимать риски и пробовать новые подходы в работе с клиентами, способны адаптироваться к изменениям и решать нестандартные задачи, вдохновляете других на достижение лучших результатов в работе с клиентами.",
					"C": "<b>Внутренние клиенты</b>:<br>Вы уважаете мнение коллег, готовы идти на компромисс и стремитесь к созданию благоприятной атмосферы в команде. Вы выполняете свою работу в соответствии с требованиями, способны решать стандартные задачи и следовать инструкциям.<br><br><b>Внешние клиенты:</b><br>Вы уважаете мнение клиентов, готовы прислушиваться к их отзывам и стремитесь к улучшению качества обслуживания. Вы выполняете свою работу в соответствии с требованиями, способны решать стандартные задачи и готовы следовать инструкциям.",
					"D": "<b>Внутренние клиенты</b>:<br>Вы редко уделяете внимание взаимоотношениям в команде, не стремитесь к созданию атмосферы доверия и открытости, редко идете на компромисс. Редко вносите значимый вклад в достижение общих целей, не стремитесь к повышению эффективности  и предложению новых идей.<br><br><b>Внешние клиенты:</b><br>Вы редко уделяете внимание отзывам клиентов, не стремитесь к повышению уровня обслуживания и редко идете на компромисс. Не вносите значимый вклад в успех компании, не стремитесь к повышению лояльности клиентов и предложению новых идей в работе с клиентами."
				},
				'ЦЕННОСТЬ "СТРАСТЬ К ИЗМЕНЕНИЯМ"': {
					"A": "Вы формируете положительное отношение к изменениям в своей работе, делаете все возможное, чтобы адаптироваться к новым условиям и процессам, вкладываетесь в свое обучение и развитие в процессе изменений. Создаете условия для постоянного совершенствования и улучшения своей работы, проявляете инициативу и творчество в своей деятельности, делаете все возможное, чтобы достигать высоких результатов в динамичной среде.",
					"B": "Вы не боитесь брать на себя ответственность за внедрение новых идей и подходов, готовы решать проблемы, возникающие в процессе изменений. Вы не боитесь принимать риски и пробовать новые подходы, готовы поддерживать коллег в процессе изменений. Вы не боитесь делиться своими знаниями и опытом, готовы помогать коллегам в их профессиональном развитии в динамичной среде.",
					"C": "Вы уважаете мнение коллег, готовы прислушиваться к их отзывам и идеям по улучшению процессов, стремитесь к созданию условий для эффективной адаптации к изменениям. Вы организуете свою работу с учетом изменений, контролируете выполнение задач и готовы помогать коллегам в решении проблем, возникающих в процессе адаптации. Вы обеспечиваете себе доступ к необходимым ресурсам, готовы поддерживать коллег в их профессиональном развитии в динамичной среде, уважаете их стремление к росту и адаптации.",
					"D": "Вы редко уделяете внимание возможностям изменений, не стремитесь к внедрению новых идей и подходов, редко идете на компромисс в процессе адаптации. Вы редко уделяете внимание возможностям изменений, не стремитесь к повышению эффективности в динамичной среде. Вы не стремитесь к своему профессиональному росту в изменяющейся среде, редко вкладываетесь в свое обучение и развитие в процессе изменений."
				},
				'ЦЕННОСТЬ "ЛИДЕРСТВО"': {
					"A": "Вы формируете атмосферу взаимоуважения и командного духа, делаете вклад в общий успех, повышаете эффективность работы команды и способствуете её развитию. Вы достигаете высоких результатов в своей работе, повышаете эффективность своих действий, вы привносите новые идеи и методы в работу. Вы формируете атмосферу доверия и взаимопонимания в команде, способствуете успешному взаимодействию между коллегами, поощряете открытое общение и обмен опытом. Вы постоянно развиваете свои профессиональные навыки, ищете новые знания и опыт, стремитесь к совершенствованию и росту.",
					"B": "Вы не боитесь брать на себя ответственность за сложные задачи, помогаете команде решать проблемы и преодолевать препятствия, вдохновляете других на достижение общих целей. Вы не боитесь принимать риски и пробовать новые подходы, способны адаптироваться к изменениям и решать нестандартные задачи, вдохновляете других на достижение лучших результатов. Вы не боитесь высказывать свое мнение и отстаивать свою позицию, способны конструктивно решать конфликты, готовы прислушиваться к мнению других. Вы не боитесь брать на себя новые задачи и пробовать новые методы работы, готовы учиться на своих ошибках, стремитесь к повышению квалификации.",
					"C": "Вы выполняете свою работу качественно и в срок, готов(а) помогать коллегам, взаимодействуете с командой в рамках своих обязанностей. Вы выполняете свою работу в соответствии с требованиями, способны решать стандартные задачи, готовы следовать инструкциям. Вы поддерживаете хорошие отношения с коллегами, готовы помогать им в необходимых ситуациях, уважаете мнение других. Вы выполняете свою работу в соответствии с требованиями, готовы учиться новому, стремитесь к улучшению своих навыков.",
					"D": "Вы редко выполняете свою работу качественно и в срок, не стремитесь к командной работе, редко помогаете коллегам. Вы редко достигаете высоких результатов, стремитесь к повышению эффективности, редко предлагаете новые идеи. Вы редко уделяете внимание отношениям с коллегами, высказываете свое мнение, не готовы прислушиваться к мнению других. Вы редко развиваете свои профессиональные навыки и не стремитесь к повышению квалификации, не готовы учиться на своих ошибках."
				},
			}


			const result = []

			for (const value of values) {
				const grade = CalcGrade(value)
				const desc = descriptions[value.title][grade] || null
				result.push({
					title: value.title,
					desc,
					grade
				})
			}

			return result
		}

		function SendResult() {
			const {result, values} = BuildResult()

			const bad_results = result.filter((r) => {
				return !r.value || (!!r.comment < r.comment_required)
			})

			if (bad_results.length) {
				ShowModal(
					"Ошибка!",
					[
						$("<p>", {
							text: "Вы ответили не на все вопросы"
						})
					]
				).then(()=>{
					console.log("test test test")
				})
				return;
			}

			$.ajax({
                type: "POST",
                url: "/custom_web_template.html?object_id=" + options.handler_id,
                secureuri: false,
                dataType: "json",
                data: {
					action: "finish_poll",
					poll_id: options.poll_id,
					answers: JSON.stringify(result.map( ({comment_required, ...r}) => r ))
				},
				success: function (response, textStatus, jqXHR) {


					if (!response.success) {
						ShowModal(
							"Ошибка!",
							$("<p>", {text: response.message})
						)
						return
					}

					const descriptions = BuildValuesDescriptions(values)

					ShowModal(
						"Успех!",
						$("<p>", {
							text: "Внимательно ознакомьтесь с интерпретацией результатов пройденного опросника по ценностям и соотнесите полученные оценки с их описанием."
						}),
						"Далее"
					).then(async () => {

						for (const d of descriptions) {
							await ShowModal(
								`${d.title} - ${d.grade}`,
								$("<p>", {html: d.desc}),
								"Далее"
							)
						}

						await ShowModal(
							"Конец!",
							[
								$("<p>", {text: "Изучи подробнее ценности компании и узнай, как использовать их для решения сложных рабочих ситуаций!"})
									.append("<br>")
									.append(
										$("<a>", {text: "Электронный курс Ценности компании Askona", href: "https://exam.askona.ru/_wt/7473481270158861029"})
									)
								
							]
						)

						window.location.href = `${window.location.origin}/home`
					})
				}
			});
		}

		function OpenModal() {
			$(".modal__overlay").fadeIn(200)
			$("body").css("overflow-y", "hidden");
		}

		function HideModal() {
			$(".modal__overlay").fadeOut(200)
			$("body").css("overflow-y", "auto");
		}

		function ShowModal(title, content, btn_text = "Закрыть") {
			$(".modal__title").html("").text(title)
			$(".modal__content").html("").append(content)
			$("#close_modal").text(btn_text)

			OpenModal()

			return new Promise((resolve) => {
				const close_fn = () => {
					HideModal()
					resolve()
				}

				$("#close_modal").unbind("click").click(close_fn)

				$(".modal__overlay").unbind("click").on("click", event => {
					if (!event.target) {
						event.target = event.srcElement
					}
					if ($(event.target).closest(".modal__window").length){
						return;
					} 
					event.preventDefault();

					close_fn();
				})

			})
		}

        $(document).ready(function(){
			$("#modal1").hide()
			$("#submit-poll").click(SendResult)	

            fillPage()
        });

    })(<%=tools.object_to_text(OPTIONS, 'json')%>)
</script>